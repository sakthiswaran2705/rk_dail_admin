<!DOCTYPE html>
<html>
<head>
    <title>City Management</title>
   <style>
    body {
        font-family: Arial;
        background: #f2f2f2;
        padding: 20px;
        position: relative;
    }

    .backbtn {
        background: #6c757d;
        color: white;
        border: none;
        cursor: pointer;
        padding: 6px 14px;
        font-size: 14px;
        border-radius: 4px;
        width: auto !important;
        display: inline-block !important;
        margin-bottom: 15px;
        margin-left: 0 !important;
        position: relative;
        left: 0;
        top: 0;
    }

    .backbtn:hover {
        background: #5a6268;
    }

    .container {
        width: 450px;
        background: white;
        padding: 20px;
        margin: auto;
        border-radius: 8px;
        box-shadow: 0 0 10px #ddd;
    }

    input, button {
        width: 100%;
        padding: 10px;
        margin-top: 10px;
        border-radius: 4px;
        border: 1px solid #ccc;
    }

    button {
        background: #007bff;
        color: white;
        border: none;
        cursor: pointer;
    }

    button:hover {
        background: #0056b3;
    }

    table {
        width: 100%;
        background: white;
        margin-top: 20px;
        border-collapse: collapse;
    }

    th, td {
        padding: 10px;
        border: 1px solid #ddd;
        text-align: center;
    }

    .edit-btn {
        background: #28a745;
    }

    .delete-btn {
        background: #dc3545;
    }

    .modal {
        display: none;
        position: fixed;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        justify-content: center;
        align-items: center;
    }

    .modal-content {
        width: 350px;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 0 10px #222;
        animation: fadeIn 0.3s;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .close-btn {
        float: right;
        cursor: pointer;
        color: red;
        font-size: 18px;
    }
</style>

<button onclick="window.location.href='admin'" class="backbtn">⬅ Back</button>
</head>
<body>

<!-- ADD CITY BOX -->
<div class="container">
    <h2>Add City</h2>

    <form id="cityForm">
        <input type="text" name="city_name" placeholder="City Name" required>
        <input type="text" name="district" placeholder="District" required>
        <input type="number" name="pincode" placeholder="Pincode" required>
        <input type="text" name="state" placeholder="State" required>

        <button type="submit">Add City</button>
    </form>

    <p id="msg"></p>
</div>

<!-- CITY TABLE + SEARCH -->
<div class="container" style="margin-top: 30px;">
    <h2>All Cities</h2>

    <input type="text" id="searchBox" placeholder="Search city, district, pincode, state..." style="margin-bottom: 15px;">

    <table id="cityTable">
        <thead>
            <tr>
                <th>City</th>
                <th>District</th>
                <th>Pincode</th>
                <th>State</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<!-- EDIT POPUP -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal()">✖</span>
        <h3>Edit City</h3>

        <form id="editForm">
            <input type="hidden" id="edit_city_id">

            <input type="text" id="edit_city_name" placeholder="City Name" required>
            <input type="text" id="edit_district" placeholder="District" required>
            <input type="number" id="edit_pincode" placeholder="Pincode" required>
            <input type="text" id="edit_state" placeholder="State" required>

            <button type="submit">Update City</button>
        </form>
    </div>
</div>

<script>

// LOAD CITIES
async function loadCities() {
    let res = await fetch("/city/all/");
    let data = await res.json();

    let tbody = document.querySelector("#cityTable tbody");
    tbody.innerHTML = "";

    data.cities.forEach(c => {
        tbody.innerHTML += `
            <tr>
                <td>${c.city_name}</td>
                <td>${c.district}</td>
                <td>${c.pincode}</td>
                <td>${c.state}</td>
                <td>
                    <button class="edit-btn" onclick="openEditPopup('${c._id}', '${c.city_name}', '${c.district}', '${c.pincode}', '${c.state}')">Edit</button>
                    <button class="delete-btn" onclick="deleteCity('${c._id}')">Delete</button>
                </td>
            </tr>
        `;
    });
}

loadCities();


// ADD CITY (AUTO LOWERCASE)
document.getElementById("cityForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    let formData = new FormData(e.target);

    // ⭐ Convert to lowercase before sending ⭐
    formData.set("city_name", formData.get("city_name").toLowerCase());
    formData.set("district", formData.get("district").toLowerCase());
    formData.set("pincode", formData.get("pincode"));
    formData.set("state", formData.get("state").toLowerCase());

    let res = await fetch("/city/add/", { method: "POST", body: formData });
    let out = await res.json();

    document.getElementById("msg").innerText = out.message;

    e.target.reset();
    loadCities();
});


// OPEN EDIT MODAL
function openEditPopup(id, name, district, pincode, state) {
    document.getElementById("edit_city_id").value = id;
    document.getElementById("edit_city_name").value = name;
    document.getElementById("edit_district").value = district;
    document.getElementById("edit_pincode").value = pincode;
    document.getElementById("edit_state").value = state;

    document.getElementById("editModal").style.display = "flex";
}

function closeModal() {
    document.getElementById("editModal").style.display = "none";
}


// UPDATE CITY (AUTO LOWERCASE)
document.getElementById("editForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    let fd = new FormData();
    fd.append("city_id", document.getElementById("edit_city_id").value);

    // ⭐ Convert to lowercase ⭐
    fd.append("city_name", document.getElementById("edit_city_name").value.toLowerCase());
    fd.append("district", document.getElementById("edit_district").value.toLowerCase());
    fd.append("pincode", document.getElementById("edit_pincode").value);
    fd.append("state", document.getElementById("edit_state").value.toLowerCase());

    let res = await fetch("/city/update/", { method: "POST", body: fd });
    let out = await res.json();

    alert(out.message);
    closeModal();
    loadCities();
});


// DELETE CITY
async function deleteCity(id) {
    if (!confirm("Do you really want to delete this city?")) return;

    let fd = new FormData();
    fd.append("city_id", id);

    let res = await fetch("/city/delete/", { method: "POST", body: fd });
    let out = await res.json();

    alert(out.message);
    loadCities();
}


// LIVE SEARCH
document.getElementById("searchBox").addEventListener("keyup", function() {
    let searchValue = this.value.toLowerCase();
    let rows = document.querySelectorAll("#cityTable tbody tr");

    rows.forEach(row => {
        let text = row.innerText.toLowerCase();
        row.style.display = text.includes(searchValue) ? "" : "none";
    });
});

</script>

</body>
</html>
