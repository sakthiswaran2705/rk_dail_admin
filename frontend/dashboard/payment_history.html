<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>User Payment History</title>

<style>
body{font-family:Arial;background:#f6f8fb;padding:20px}
.container{max-width: 900px; margin: 0 auto;}
.card{background:#fff;padding:20px;border-radius:10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);}
h2{margin-top:0;}
.back-btn{display:inline-block;margin-bottom:15px;color:#666;text-decoration:none;font-size:14px}
.back-btn:hover{text-decoration:underline}

table{width:100%;border-collapse:collapse;margin-top:15px}
th,td{padding:12px 10px;border-bottom:1px solid #eee;text-align:left}
th{background:#333;color:white} /* Darker header for detail view */

.badge{padding:4px 8px;border-radius:6px;color:white;font-size:12px;text-transform: capitalize;}

/* Status Colors */
.active{background:#28a745}
.expired{background:#dc3545}
.pending{background:#ffc107;color:black}

.btn{padding:6px 12px;border:none;cursor:pointer;border-radius:4px;font-size:12px}
.btn-danger{background:#dc3545;color:white}
.btn-danger:hover{background:#b02a37}
</style>
</head>

<body>

<div class="container">
  <a href="admin_payments" class="back-btn">← Back to Dashboard</a>

  <div class="card">
    <h2>History for: <span id="userTitle" style="color:#0b74de">...</span></h2>

    <table>
      <thead>
        <tr>
          <th>Plan Name</th>
          <th>Amount</th>
          <th>Status</th>
          <th>Expiry Date</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="plansBody"></tbody>
    </table>
  </div>
</div>

<script>
const API = ""; // Enter your API URL here

// 1. Get User ID/Email from URL
const params = new URLSearchParams(window.location.search);
const userQuery = params.get("q");

// Set Title
if(userQuery){
    document.getElementById("userTitle").innerText = userQuery;
    loadUserPlans(userQuery);
} else {
    alert("No user selected");
    window.location.href = "admin_payments";
}

async function loadUserPlans(q){
  try {
    let res = await fetch(`${API}/admin/payments/user/?q=${encodeURIComponent(q)}`);
    let json = await res.json();

    let body = document.getElementById("plansBody");
    body.innerHTML="";

    if(json.data.length === 0){
        body.innerHTML = "<tr><td colspan='5'>No history found for this user.</td></tr>";
        return;
    }

    json.data.forEach(p=>{
      // Determine badge color class based on status text
      let statusClass = "pending";
      if(p.status === "active") statusClass = "active";
      if(p.status === "expired") statusClass = "expired";

      let tr=document.createElement("tr");
      tr.innerHTML=`
        <td>${p.plan_name}</td>
        <td>₹${p.amount || 0}</td>
        <td><span class="badge ${statusClass}">${p.status}</span></td>
        <td>${p.expiry_date ? new Date(p.expiry_date).toLocaleDateString() : "-"}</td>
        <td>
          <button class="btn btn-danger" onclick="del('${p.payment_id}')">Delete</button>
        </td>
      `;
      body.appendChild(tr);
    });
  } catch(err){
      console.error(err);
      alert("Error loading user details");
  }
}

async function del(pid){
  if(!confirm("Are you sure you want to delete this payment record?")) return;

  try {
    await fetch(`${API}/admin/payments/delete/${pid}`,{method:"DELETE"});
    alert("Deleted successfully");
    // Reload the list
    loadUserPlans(userQuery);
  } catch(e) {
      alert("Error deleting");
  }
}
</script>

</body>
</html>