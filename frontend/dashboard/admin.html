<!DOCTYPE html>
<html>
<head>
    <title>Admin Panel</title>
    <style>
        body { font-family: Arial; background: #f7f7f7; padding: 20px; }
        h1 { margin-bottom: 15px; }
        h2 { margin-top: 40px; }
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            margin-bottom: 30px;
        }
        th, td { padding: 10px; border: 1px solid #ddd; }
        th { background: #333; color: white; }
        button {
            padding: 6px 12px;
            background: #007bff; /* Default Blue */
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            margin-right: 5px; /* Added spacing between buttons */
            margin-bottom: 5px;
        }
        button:hover { opacity: 0.9; }

        /* Button Colors */
        .green { background:#28a745 }
        .purple { background:#6f42c1 }
        .orange { background:#ff7f00 }
        .teal   { background:#17a2b8 }
        .gold   { background:#b8860b } /* New Color for Payments */
        .rejectbtn { background: #dc3545; }
        .rejectbtn:hover { background: #b52a37; }

        /* SEARCH BAR */
        #shopSearch {
            padding: 8px;
            width: 250px;
            margin-bottom: 10px;
            border: 1px solid #aaa;
            border-radius: 5px;
        }
    </style>
</head>
<body>

<h1>Admin Dashboard</h1>

<button onclick="window.location.href='all_shop'" class="green">View All Shops</button>
<button onclick="window.location.href='city_creation'">Add City</button>
<button onclick="window.location.href='category_creation'" class="purple">Add Category</button>
<button onclick="window.location.href='pending_offers_page'" class="orange">Pending Offers</button>
<button onclick="window.location.href='jobs'" class="teal">Jobs</button>

<button onclick="window.location.href='admin_payments'" class="gold">Payments</button>

<h2>Pending Shops</h2>

<input type="text" id="shopSearch" placeholder="Search shops..." onkeyup="searchShops()">

<table>
    <thead>
        <tr>
            <th>Shop Name</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Address</th>
            <th>City</th>
            <th>Categories</th>
            <th>Keywords</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody id="pendingShops"></tbody>
</table>

<script>

async function loadPendingShops() {
    try {
        let res = await fetch("/pending_shops/");
        let json = await res.json();
        let data = json.data || [];

        window._shops = data; // store for search filter

        renderShops(data);
    } catch (e) {
        console.log("Error loading shops", e);
    }
}

function renderShops(list) {
    let tb = document.getElementById("pendingShops");
    tb.innerHTML = "";

    if (list.length === 0) {
        tb.innerHTML = "<tr><td colspan='8'>No Pending Shops</td></tr>";
        return;
    }

    list.forEach(s => {
        let cityName = s.city ? (s.city.name || "") : "";
        let categoryNames = s.categories?.map(c => c.name) || [];

        tb.innerHTML += `
            <tr>
                <td>${s.shop_name || ""}</td>
                <td>${s.email || ""}</td>
                <td>${s.phone_number || ""}</td>
                <td>${s.address || ""}</td>
                <td>${cityName}</td>
                <td>${categoryNames.join(", ")}</td>
                <td>${(s.keywords || []).join(", ")}</td>
                <td>
                    <button onclick="approveShop('${s._id}')">Approve</button>
                    <button class="rejectbtn" onclick="rejectShop('${s._id}')">Reject</button>
                </td>
            </tr>
        `;
    });
}

// SEARCH FUNCTION
function searchShops() {
    let q = document.getElementById("shopSearch").value.toLowerCase();
    if(!window._shops) return;

    let filtered = window._shops.filter(s =>
        (s.shop_name || "").toLowerCase().includes(q) ||
        (s.email || "").toLowerCase().includes(q) ||
        (s.phone_number || "").toLowerCase().includes(q)
    );
    renderShops(filtered);
}

async function approveShop(id) {
    if(!confirm("Approve this shop?")) return;
    let res = await fetch(`/approve_shop?shop_id=${id}`);
    let out = await res.json();
    alert(out.message || "Approved");
    loadPendingShops();
}

async function rejectShop(id) {
    if(!confirm("Reject this shop?")) return;
    let res = await fetch(`/rejected_shop?shop_id=${id}`);
    let out = await res.json();
    alert(out.message || "Rejected");
    loadPendingShops();
}

loadPendingShops();

</script>

</body>
</html>